# AI-Powered Image Selection v3.6 - Complete Implementation

## Context

Dit is een Node.js script voor het automatisch selecteren van educatieve afbeeldingen voor quiz-vragen voor Nederlandse middelbare scholieren (14-16 jaar). Het script gebruikt Gemini AI voor vision validation van afbeeldingen.

## Probleem dat v3.6 oplost

v3.5 had een 46% faalpercentage door:
1. **Geen concept matching** - "breast for skeleton question" errors
2. **Geen taalcontrole** - Poolse/Oekraïense/Litouwse labels werden geaccepteerd
3. **Slechte fallback** - "soup for collagen question" via text-score fallback
4. **Geen content-type filtering** - Abstracte kunst werd geaccepteerd
5. **Dubbele afbeeldingen** - Dezelfde afbeelding voor meerdere vragen

## Architectuur v3.6

```
┌─────────────────────────────────────────────────────────────┐
│                    BATCH AI (12 vragen)                      │
│  → Genereert zoektermen, categoryHints, riskProfile, etc.   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              MULTI-SOURCE SEARCH                             │
│  → Unsplash, Pexels, Commons, Wikipedia                     │
│  → Text-based scoring + pageid voor dedup                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              AI VISION VALIDATION (v3.6)                     │
│                                                              │
│  8 HARD REJECT GATES (in volgorde):                         │
│  1. LANGUAGE GATE - Non-NL/EN tekst → REJECT                │
│  2. CONTENT-TYPE GATE - abstract_art/food_drink → REJECT    │
│  3. CONCEPT GATE - skeleton vraag + breast → REJECT         │
│  4. HUMAN_VS_ANIMAL - menselijke anatomie moet mens zijn   │
│  5. LABELED_DIAGRAM - intent vereist diagram type           │
│  6. READABILITY - poor readability → REJECT                 │
│  7. AGE_APPROPRIATE - te complex voor 14-16 → REJECT        │
│  8. EXPLICIT_REJECT - AI zegt valid=false → REJECT          │
│                                                              │
│  FAIL-CLOSED: Geen kandidaat passed → return NULL           │
│  (geen text-score fallback meer!)                           │
└─────────────────────────────────────────────────────────────┘
```

## Concept Vocabulary voor Biologie

```javascript
const BIOLOGIE_CONCEPT_VOCABULARY = {
  // Skeleton/bones
  skelet: { expectedConcept: 'skeleton', allowedConcepts: ['skeleton', 'bone', 'skull', 'spine', 'vertebra', 'rib', 'pelvis', 'femur', 'tibia'] },
  bot: { expectedConcept: 'bone', allowedConcepts: ['bone', 'skeleton', 'femur', 'tibia', 'humerus', 'bone_tissue', 'osteon'] },
  botten: { expectedConcept: 'bone', allowedConcepts: ['bone', 'skeleton', 'femur', 'tibia', 'humerus', 'bone_tissue'] },
  schedel: { expectedConcept: 'skull', allowedConcepts: ['skull', 'cranium', 'head', 'skeleton'] },
  wervelkolom: { expectedConcept: 'spine', allowedConcepts: ['spine', 'vertebra', 'backbone', 'skeleton'] },
  fontanel: { expectedConcept: 'fontanelle', allowedConcepts: ['fontanelle', 'skull', 'baby_skull', 'cranium'] },

  // Bone tissue
  botweefsel: { expectedConcept: 'bone_tissue', allowedConcepts: ['bone_tissue', 'osteon', 'bone_cell', 'osteocyte'] },
  collageen: { expectedConcept: 'collagen', allowedConcepts: ['collagen', 'bone_tissue', 'connective_tissue', 'fibers'] },
  kraakbeen: { expectedConcept: 'cartilage', allowedConcepts: ['cartilage', 'joint', 'bone'] },

  // Joints
  gewricht: { expectedConcept: 'joint', allowedConcepts: ['joint', 'knee', 'elbow', 'hip', 'shoulder', 'synovial'] },
  gewrichtssmeer: { expectedConcept: 'synovial_fluid', allowedConcepts: ['synovial_fluid', 'joint', 'synovial'] },
  knie: { expectedConcept: 'knee', allowedConcepts: ['knee', 'joint', 'leg'] },

  // Muscles
  spier: { expectedConcept: 'muscle', allowedConcepts: ['muscle', 'biceps', 'triceps', 'quadriceps', 'muscle_fiber'] },
  biceps: { expectedConcept: 'biceps', allowedConcepts: ['biceps', 'arm_muscle', 'muscle'] },
  samentrekken: { expectedConcept: 'muscle_contraction', allowedConcepts: ['muscle_contraction', 'muscle', 'contraction'] },
  antagonist: { expectedConcept: 'antagonist_muscle', allowedConcepts: ['antagonist_muscle', 'muscle_pair', 'biceps_triceps'] },

  // Nervous system
  zenuw: { expectedConcept: 'nerve', allowedConcepts: ['nerve', 'neuron', 'nervous_system'] },
  reflex: { expectedConcept: 'reflex', allowedConcepts: ['reflex', 'reflex_arc', 'nervous_system'] },
  motorisch: { expectedConcept: 'motor', allowedConcepts: ['motor_neuron', 'motor_cortex', 'muscle', 'movement'] },

  // RSI / posture
  rsi: { expectedConcept: 'rsi', allowedConcepts: ['rsi', 'repetitive_strain', 'ergonomics', 'wrist', 'posture'] },
  zithouding: { expectedConcept: 'sitting_posture', allowedConcepts: ['sitting_posture', 'posture', 'ergonomics', 'chair', 'desk'] },

  // Training
  training: { expectedConcept: 'training', allowedConcepts: ['training', 'exercise', 'fitness', 'sport', 'muscle'] },
  squats: { expectedConcept: 'squats', allowedConcepts: ['squats', 'leg_exercise', 'training', 'quadriceps'] },
};
```

## Reject Content Types

```javascript
const REJECT_CONTENT_TYPES = [
  'abstract_art',      // gekleurde touwen, abstracte vormen
  'network_graph',     // netwerk diagrammen
  'table_wordlist',    // woordenlijsten/tabellen
  'map_transit',       // metro/bus/trein kaarten
  'music_instrument',  // muziekinstrumenten
  'food_drink',        // soep, eten, drinken
  'scientific_method', // wetenschappelijke methode diagrammen
  'unrelated_diagram', // diagrammen zonder verband
];
```

## Vision Validation Prompt (v3.6)

```javascript
const prompt = `Je bent een ZEER STRENGE beoordelaar van educatieve afbeeldingen voor Nederlandse middelbare scholieren (14-16 jaar).

VAK: ${subject || 'Onbekend'}
VRAAG: ${questionText}
INTENT: ${intent}
TOPIC KEYWORDS: ${topicKeywordsStr}
RISK PROFILE: ${riskProfile}
EXPECTED CONCEPT: ${expectedConceptStr}
ALLOWED CONCEPTS: ${allowedConceptsStr}

ABSOLUTE HARD REJECT RULES (valid=false):
1. TAAL: Als er tekst in de afbeelding staat die NIET Nederlands of Engels is → REJECT
2. CONTENT TYPE: Als de afbeelding een van deze types is → REJECT:
   - abstract_art (abstracte kunst, gekleurde lijnen/vormen zonder anatomische betekenis)
   - network_graph (netwerk/graph diagrammen die geen anatomie tonen)
   - table_wordlist (tabellen met woordenlijsten)
   - map_transit (metro/bus/trein kaarten)
   - music_instrument (muziekinstrumenten)
   - food_drink (eten/drinken zoals soep, gerechten)
   - scientific_method (wetenschappelijke methode diagrammen)
   - unrelated_diagram (diagrammen die NIETS met het onderwerp te maken hebben)
3. CONCEPT MATCH: Als EXPECTED CONCEPT gegeven is en de afbeelding toont iets COMPLEET anders → REJECT
   Voorbeeld: vraag over skelet maar afbeelding toont borstklier → REJECT
4. HUMAN VS ANIMAL: Als RISK PROFILE = human_vs_animal en je ziet GEEN mens → REJECT
5. READABILITY: Als de afbeelding te klein, vaag, of onleesbaar is → REJECT
6. COMPLEXITY: Als het te complex is voor 14-16 jarigen (bijv. zeer gedetailleerd medisch diagram) → REJECT

WERKWIJZE:
1) Beschrijf kort wat je ECHT ziet (max 2 zinnen). Wees specifiek.
2) Detecteer eventuele tekst en de taal ervan.
3) Bepaal welk concept de afbeelding werkelijk toont (predicted_concept).
4) Beoordeel of het concept past bij de vraag.
5) Score ALLEEN als alle reject rules zijn gepasseerd.

Antwoord als JSON:
{
  "valid": true/false,
  "score": 0-100,
  "observations": "wat zie je echt (1-2 zinnen)",
  "predicted_concept": "wat de afbeelding werkelijk toont (bijv: skeleton, muscle, bone, breast, soup, abstract_art)",
  "concept_matches": true/false,
  "detected_subject": "human|animal|mixed|unknown",
  "has_text": true/false,
  "text_languages": ["nl", "en", "pl", "uk", "lt", "de", "other"],
  "content_type": "photo|labeled_diagram|diagram|abstract_art|network_graph|table_wordlist|map_transit|food_drink|music_instrument|unknown",
  "image_type": "photo|labeled_diagram|diagram|map|text_heavy|unknown",
  "readability": "good|ok|poor",
  "complexity_level": "simple|moderate|complex",
  "age_appropriate": true/false,
  "issues": ["probleem 1", "probleem 2"],
  "reject_reason": "specifieke reden als valid=false",
  "reason": "korte uitleg in het Nederlands"
}

BELANGRIJK: Wees EXTREEM STRENG. Een foute afbeelding is ERGER dan geen afbeelding.
Bij ELKE twijfel: valid=false.
Geef ALLEEN de JSON.`;
```

## Hard Reject Gates (JavaScript)

```javascript
// GATE 1: Language check - reject non-NL/EN text
if (result.has_text && result.text_languages) {
  const allowedLanguages = ['nl', 'en'];
  const hasInvalidLanguage = result.text_languages.some(
    lang => lang && !allowedLanguages.includes(lang.toLowerCase())
  );
  if (hasInvalidLanguage) {
    hardReject = true;
    rejectReason = `Non-NL/EN text detected: ${result.text_languages.join(', ')}`;
  }
}

// GATE 2: Content type check - reject banned content types
if (!hardReject && result.content_type && REJECT_CONTENT_TYPES.includes(result.content_type)) {
  hardReject = true;
  rejectReason = `Banned content type: ${result.content_type}`;
}

// GATE 3: Concept match check (for biologie)
if (!hardReject && expectedConcept && result.predicted_concept) {
  const predictedLower = result.predicted_concept.toLowerCase();
  const conceptMatches = allowedConcepts.some(c =>
    predictedLower.includes(c.toLowerCase()) || c.toLowerCase().includes(predictedLower)
  );
  if (!conceptMatches && result.concept_matches === false) {
    hardReject = true;
    rejectReason = `Concept mismatch: expected ${expectedConcept}, got ${result.predicted_concept}`;
  }
}

// GATE 4: human_vs_animal risk profile
if (!hardReject && riskProfile === 'human_vs_animal' && result.detected_subject !== 'human') {
  hardReject = true;
  rejectReason = `Detected ${result.detected_subject}, not human`;
}

// GATE 5: labeled_diagram intent requires diagram type
if (!hardReject && intent === 'labeled_diagram' && !['labeled_diagram', 'diagram'].includes(result.image_type)) {
  hardReject = true;
  rejectReason = `Image type ${result.image_type}, not a diagram`;
}

// GATE 6: poor readability
if (!hardReject && result.readability === 'poor') {
  hardReject = true;
  rejectReason = 'Poor readability';
}

// GATE 7: Age appropriateness
if (!hardReject && result.age_appropriate === false) {
  hardReject = true;
  rejectReason = `Not age-appropriate: ${result.complexity_level} complexity`;
}

// GATE 8: Explicit valid=false from AI
if (!hardReject && result.valid === false) {
  hardReject = true;
  rejectReason = result.reject_reason || result.reason || 'AI rejected image';
}
```

## Fail-Closed Fallback

```javascript
// v3.6: FAIL-CLOSED - No candidate passed AI validation
// DO NOT return a bad image. Return null instead.
// This prevents the "soup for collagen" and "breast for skeleton" errors.
if (validatedCandidates.length > 0 && !foundValid) {
  process.stdout.write(` [FAIL-CLOSED: all ${validatedCandidates.length} candidates rejected]`);
  return null;  // NO FALLBACK TO TEXT-SCORE!
}
```

## Canonical Deduplication

```javascript
function getCanonicalKey(candidate) {
  // For Wikimedia Commons: use pageid (most reliable)
  if (candidate.pageid) {
    return `commons:${candidate.pageid}`;
  }

  // For Unsplash/Pexels: use their unique ID
  if (candidate.source === 'unsplash' && candidate.id) {
    return `unsplash:${candidate.id}`;
  }
  if (candidate.source === 'pexels' && candidate.id) {
    return `pexels:${candidate.id}`;
  }

  // Fallback: normalize title
  const title = (candidate.title || '')
    .replace(/^File:/i, '')
    .toLowerCase()
    .replace(/\.(jpg|jpeg|png|gif|svg|webp|tiff?)$/i, '')
    .replace(/[_\s]+/g, '_')
    .trim();

  return title ? `title:${title}` : `url:${candidate.imageUrl}`;
}

// In scoreCandidate:
const canonicalKey = getCanonicalKey(candidate);
if (usedImages.has(canonicalKey)) return -1000;

// When adding to usedImages:
usedImages.add(canonicalKey);  // NOT imageUrl!
```

## Rate Limit Handling

```javascript
const rateLimitState = {
  gemini: { lastRateLimit: 0, backoffMs: 200 },
  unsplash: { lastRateLimit: 0, backoffMs: 100 },
  pexels: { lastRateLimit: 0, backoffMs: 100 },
  commons: { lastRateLimit: 0, backoffMs: 100 },
};

async function withRetry(fn, retries = 3, apiName = 'gemini') {
  const state = rateLimitState[apiName];

  // Apply adaptive delay if recently rate limited
  const timeSinceRateLimit = Date.now() - state.lastRateLimit;
  if (timeSinceRateLimit < 60000 && state.backoffMs > 200) {
    await sleep(state.backoffMs);
  }

  for (let attempt = 0; attempt <= retries; attempt++) {
    try {
      const result = await fn();
      // Success: reduce backoff
      state.backoffMs = Math.max(200, state.backoffMs * 0.8);
      return result;
    } catch (err) {
      const isRateLimit = err.message.includes('429') || err.message.includes('quota');

      if (isRateLimit) {
        state.lastRateLimit = Date.now();
        state.backoffMs = Math.min(30000, state.backoffMs * 2);
      }

      if (attempt === retries || !isRateLimit) throw err;

      const delay = 2000 * Math.pow(2, attempt) + Math.random() * 1000;
      console.log(`[${apiName}] Rate limited, waiting ${delay}ms...`);
      await sleep(delay);
    }
  }
}
```

## Usage

```bash
# Test run (dry run)
GEMINI_API_KEY=key UNSPLASH_ACCESS_KEY=key node ai-select-images.js --quiz data/biologie/quiz.json

# Apply images to quiz file
GEMINI_API_KEY=key UNSPLASH_ACCESS_KEY=key node ai-select-images.js --quiz data/biologie/quiz.json --apply

# Replace ALL existing images (re-evaluate everything)
GEMINI_API_KEY=key UNSPLASH_ACCESS_KEY=key node ai-select-images.js --quiz data/biologie/quiz.json --replace --apply
```

## Expected Results

Met v3.6 verwachten we:
- **Taalcontrole**: Geen Poolse/Oekraïense/Litouwse labels meer
- **Concept matching**: Geen "breast for skeleton" errors
- **Fail-closed**: Geen "soup for collagen" errors (liever geen afbeelding)
- **Content-type filtering**: Geen abstracte kunst of netwerk-diagrammen
- **Deduplicatie**: Geen dubbele afbeeldingen meer
- **Rate limiting**: Minder 429 errors

---

*v3.6 geïmplementeerd op basis van ChatGPT analyse van 46% failure rate in v3.5*
